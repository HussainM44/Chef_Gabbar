{% extends 'base.html' %}

{% block content%}

<div class="menu-container {% if buckets %}menu-with-bucket{% endif %}">


  <h1 class="menu-title">Menu</h1>

  <!-- Login Prompt for Unauthenticated Users -->
  {% if not user.is_authenticated%}
  <div class="login-prompt">
    <h4 class="login-prompt-title">Ready to order? Log in or sign up now!</h4>
    <ul class="login-prompt-links">
      <li><a href="{% url 'signup' %}" class="login-prompt-link">Sign Up</a></li>
      <li><a href="{% url 'login' %}" class="login-prompt-link">Login</a></li>
    </ul>
  </div>
  {% endif %}

  <!-- Search Section -->
  <div class="search-section">
    <h2 class="search-title">Search Dishes</h2>
    <form method="get" action="{% url 'menu_list' %}" class="search-form">
      <input type="text" name="q" placeholder="Search for a dish..." value="{{ search_query }}" class="search-input">
      <button type="submit" class="search-btn">Search</button>
    </form>

    {% if search_query %}
    <h3 class="search-results-title">Results for "{{ search_query }}":</h3>
    {% if search_results %}
    <div class="dishes-grid">
      {% for dish in search_results %}
      <div class="dish-card">
        <div class="dish-image-wrapper">
          {% load static %}
          {% if dish.dish_image %}
          <img src="{{ dish.dish_image.url }}" alt="{{ dish.name }}" class="dish-image">
          {% else %}
          <div class="dish-image-placeholder">No Image</div>
          {% endif %}
        </div>
        <div class="dish-info">
          <h3 class="dish-name">{{dish.name}}</h3>
          <p class="dish-price">{{dish.price}} BHD</p>
          <p class="dish-description">{{dish.description}}</p>
        </div>
        {% if not user.is_superuser %}
        {% if user.is_authenticated %}
        <form method="POST" action="{% url 'add_dish' dish.id %}" class="dish-add-form">
          {% csrf_token %}
          <button type="submit" class="dish-add-btn">➕</button>
        </form>
        {% endif %}
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="no-results">No dishes found.</p>
    {% endif %}
    {% endif %}
  </div>
   <!-- Admin Create Menu Button -->
  {% if user.is_superuser %}
  <div class="admin-actions">
    <a href="{% url 'menu_create' %}" class="create-btn">Create Your Cuisine</a>
  </div>
  {%endif%}
  <!-- All Menu Items -->
  <div class="menu-list">
    {% for menu in menu_list %}
    <div class="cuisine-section">
      <h2 class="cuisine-title">{{menu.cuisine}}</h2>
      <div class="dishes-grid">
        {% for dish in menu.dish_set.all %}
        <div class="dish-card">
          <div class="dish-image-wrapper">
            {% load static %}
            {% if dish.dish_image %}
            <img src="{{ dish.dish_image.url }}" alt="{{ dish.name }}" class="dish-image">
            {% else %}
            <div class="dish-image-placeholder">No Image</div>
            {% endif %}
          </div>
          <div class="dish-info">
            <h3 class="dish-name">{{dish.name}}</h3>
            <p class="dish-price">{{dish.price}} BHD</p>
            <p class="dish-description">{{dish.description}}</p>
          </div>
          {% if not user.is_superuser %}
          {% if user.is_authenticated %}
          <form method="POST" action="{% url 'add_dish' dish.id %}" class="dish-add-form">
            {% csrf_token %}
            <button type="submit" class="dish-add-btn">➕</button>
          </form>
          {% endif %}
          {% endif %}
          {% if user.is_superuser %}
          <div class="admin-dish-actions">
            <a href="{% url 'dish_delete' dish.pk %}" class="admin-action-link delete">Delete</a>
            <a href="{% url 'dish_update' dish.pk %}" class="admin-action-link edit">Update</a>
          </div>
          {%endif%}
        </div>
        {% endfor %}
      </div>

      {% if user.is_superuser %}
      <div class="admin-menu-actions">
        <a href="{% url 'dish_create' menu.pk %}" class="admin-action-btn">Add A Dish</a>
        <a href="{% url 'menu_delete' menu.pk %}" class="admin-action-btn delete">Delete {{menu.cuisine}}</a>
      </div>
      {%endif%}
    </div>
    {% endfor %}
  </div>

  <!-- Bucket (Cart) Sidebar -->
  {% if buckets %}
  <div class="bucket-container">
    <h2 class="bucket-title">Bucket</h2>

    {% for bucket in buckets %}
    <div class="bucket-content">
      <h3 class="bucket-items-title">Items:</h3>

      {% if bucket.itemqty_set.all %}
      <div class="bucket-items">
        {% for item in bucket.itemqty_set.all %}
        {% if item.dish %}
        <div class="bucket-item">
          <p class="bucket-item-info">
            <strong class="bucket-item-name">{{ item.dish.name }}</strong>
            <span class="bucket-item-quantity">{{ item.quantity }} × {{ item.dish.price|floatformat:2 }} BHD</span>
            <span class="bucket-item-total">= {{ item.total|floatformat:2 }} BHD</span>
          </p>

          {% if bucket.service_type == "P" %}
          <div class="bucket-item-controls">
            <form method="POST" action="{% url 'add_dish' item.dish.id %}" class="bucket-control-form">
              {% csrf_token %}
              <button type="submit" class="bucket-control-btn">➕</button>
            </form>

            <form method="POST" action="{% url 'decrease_dish' bucket.id item.dish.id %}" class="bucket-control-form">
              {% csrf_token %}
              <button type="submit" class="bucket-control-btn">➖</button>
            </form>

            <form method="POST" action="{% url 'single_item_delete' bucket.id item.dish.id %}" class="bucket-control-form">
              {% csrf_token %}
              <button type="submit" class="bucket-control-btn delete">✖️</button>
            </form>
          </div>
          {% endif %}
        </div>
        {% endif %}
        {% endfor %}
      </div>

      <p class="bucket-total"><strong>Total: {{ bucket.total_price|floatformat:2 }} BHD</strong></p>

      {% if bucket.service_type == 'P' %}
      <div class="bucket-service-form">
        <form method="POST" action="{% url 'service_type' bucket.id %}" class="service-type-form">
          {% csrf_token %}
          <div class="service-form-fields">
            {{ form.as_p }}
          </div>
          <button type="submit" class="service-submit-btn">Submit</button>
        </form>

        <form method="POST" action="{% url 'bucket_delete' bucket.id %}" class="bucket-clear-form">
          {% csrf_token %}
          <button type="submit" class="bucket-clear-btn">Clear Bucket</button>
        </form>
      </div>

      {% else %}
      <div class="bucket-checkout">
        <div class="service-type-display-wrapper">
          <p class="service-type-display">Service Type: {{ bucket.get_service_type_display }}</p>
          {% if bucket.id not in bucket_added %}
          <form method="POST" action="{% url 'cancel_service_type' bucket.id %}" class="cancel-service-form-inline">
            {% csrf_token %}
            <button type="submit" class="cancel-service-btn-inline">✖</button>
          </form>
          {% endif %}
        </div>

        {% if bucket.id not in bucket_added %}
        <div class="checkout-actions">
          <form method="POST" action="{% url 'checkout' bucket.id %}" class="checkout-form">
            {% csrf_token %}
            <button type="submit" class="checkout-btn online">Pay Online</button>
          </form>

          <form method="POST" action="{% url 'bucketToOrder' bucket.id %}" class="checkout-form">
            {% csrf_token %}
            <button type="submit" class="checkout-btn cash">Pay Cash</button>
          </form>

          <form method="POST" action="{% url 'bucket_delete' bucket.id %}" class="checkout-form">
            {% csrf_token %}
            <button type="submit" class="checkout-btn clear">Clear Bucket</button>
          </form>
        </div>
        {% else %}
        <p class="added-to-cart">Added to Cart ✅</p>
        {% endif %}
      </div>
      {% endif %}
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>

{%endblock%}
